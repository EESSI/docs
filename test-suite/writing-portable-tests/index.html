
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://eessi.github.io/docs/test-suite/writing-portable-tests/">
      
      
        <link rel="prev" href="../available-tests/">
      
      
        <link rel="next" href="../release-notes/">
      
      
      <link rel="icon" href="../../img/logos/EESSI.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Writing tests - European Environment for Scientific Software Installations (EESSI)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
      <link rel="stylesheet" href="../../available_software/css/style_table.css">
    
      <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.semanticui.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#writing-portable-tests" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="European Environment for Scientific Software Installations (EESSI)" class="md-header__button md-logo" aria-label="European Environment for Scientific Software Installations (EESSI)" data-md-component="logo">
      
  <img src="../../img/logos/EESSI.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            European Environment for Scientific Software Installations (EESSI)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Writing tests
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/EESSI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    EESSI @ GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="European Environment for Scientific Software Installations (EESSI)" class="md-nav__button md-logo" aria-label="European Environment for Scientific Software Installations (EESSI)" data-md-component="logo">
      
  <img src="../../img/logos/EESSI.png" alt="logo">

    </a>
    European Environment for Scientific Software Installations (EESSI)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/EESSI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    EESSI @ GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../filesystem_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filesystem layer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../compatibility_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compatibility layer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../software_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Software layer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../software_layer/cpu_targets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Supported CPU targets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Available software and repositories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Available software and repositories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../available_software/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Repositories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Repositories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../repositories/software.eessi.io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../repositories/riscv.eessi.io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RISC-V
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../repositories/pilot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pilot
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../repositories/dev.eessi.io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development repository
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Installation and configuration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Installation and configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_access/is_eessi_accessible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Is EESSI already installed?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_access/native_installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Native
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_access/eessi_container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Windows and macOS
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Windows and macOS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_access/eessi_wsl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Windows with WSL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_access/eessi_limactl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    macOS with Lima
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Configuring EESSI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Configuring EESSI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../site_specific_config/host_injections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How to configure EESSI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../site_specific_config/gpu/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GPU support
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../site_specific_config/lmod_hooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom LMOD hooks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Basic usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Basic usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_eessi/setting_up_environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Set up environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_eessi/basic_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_eessi/eessi_demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demos
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_eessi/eessi_in_ci/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    EESSI in CI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Advanced usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Advanced usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../filesystem_layer/stratum1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setting up your Stratum
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_eessi/building_on_eessi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building software with EESSI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" checked>
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Test suite
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Test suite
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation & configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ReFrame-configuration-file/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ReFrame configuration file
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../available-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Available tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Writing tests
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Writing tests
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-overview" class="md-nav__link">
    <span class="md-ellipsis">
      High-level overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Test requirements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-tutorial-for-writing-a-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-step tutorial for writing a portable ReFrame test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-step tutorial for writing a portable ReFrame test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-writing-job-scripts-to-execute-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: writing job scripts to execute tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-implementing-as-a-non-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: implementing as a non-portable ReFrame test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: implementing as a portable ReFrame test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: implementing as a portable ReFrame test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-eessi_mixin-works" class="md-nav__link">
    <span class="md-ellipsis">
      How EESSI_Mixin works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheriting-from-eessi_mixin" class="md-nav__link">
    <span class="md-ellipsis">
      Inheriting from EESSI_Mixin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-hard-coded-test-scales" class="md-nav__link">
    <span class="md-ellipsis">
      Removing hard-coded test scales
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-module-names" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded module names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-system-names-and-programming-environments" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded system names and programming environments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-sufficient-ram-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting sufficient RAM memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-binding" class="md-nav__link">
    <span class="md-ellipsis">
      Process binding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ci-tag" class="md-nav__link">
    <span class="md-ellipsis">
      CI Tag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#readonly-files" class="md-nav__link">
    <span class="md-ellipsis">
      Readonly files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-binding-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Thread binding (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skipping-test-instances" class="md-nav__link">
    <span class="md-ellipsis">
      Skipping test instances when required (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-a-time-limit-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Setting a time limit (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-of-mpi4py-test" class="md-nav__link">
    <span class="md-ellipsis">
      Background of the mpi4py test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background of the mpi4py test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-mpi4py-test" class="md-nav__link">
    <span class="md-ellipsis">
      The mpi4py test
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-portable-reframe-test-legacy" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: implementing as a portable ReFrame test without using EESSI_Mixin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: implementing as a portable ReFrame test without using EESSI_Mixin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-test-scales-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded test scales (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-module-names-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded module names (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-valid_systems-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded valid_systems (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-sufficient-memory-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting sufficient memory (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-taskprocessthread-binding-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting task/process/thread binding (recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-omp_num_threads-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Defining OMP_NUM_THREADS (recommended)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release notes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Known issues and workarounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Known issues and workarounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../known_issues/eessi-2023.06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    v2023.06
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Adding software to EESSI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Adding software to EESSI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    For contributors
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            For contributors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/contribution_policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contribution policy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/opening_pr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Open PR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/debugging_failed_builds/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/adding_development_software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development repository
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    For maintainers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            For maintainers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BTD bot
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/building_software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../adding_software/deploying_software/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploying software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../software_layer/build_nodes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Build nodes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Community and support
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Community and support
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../support/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting support
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../meetings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Meetings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../talks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Talks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contact info
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Systems where EESSI is available
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../governance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Governance
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-overview" class="md-nav__link">
    <span class="md-ellipsis">
      High-level overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Test requirements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-tutorial-for-writing-a-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-step tutorial for writing a portable ReFrame test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-step tutorial for writing a portable ReFrame test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-writing-job-scripts-to-execute-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: writing job scripts to execute tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-implementing-as-a-non-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: implementing as a non-portable ReFrame test
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-portable-reframe-test" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: implementing as a portable ReFrame test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: implementing as a portable ReFrame test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-eessi_mixin-works" class="md-nav__link">
    <span class="md-ellipsis">
      How EESSI_Mixin works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inheriting-from-eessi_mixin" class="md-nav__link">
    <span class="md-ellipsis">
      Inheriting from EESSI_Mixin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-hard-coded-test-scales" class="md-nav__link">
    <span class="md-ellipsis">
      Removing hard-coded test scales
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-module-names" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded module names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-system-names-and-programming-environments" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded system names and programming environments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-sufficient-ram-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting sufficient RAM memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#process-binding" class="md-nav__link">
    <span class="md-ellipsis">
      Process binding
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ci-tag" class="md-nav__link">
    <span class="md-ellipsis">
      CI Tag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#readonly-files" class="md-nav__link">
    <span class="md-ellipsis">
      Readonly files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-binding-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Thread binding (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skipping-test-instances" class="md-nav__link">
    <span class="md-ellipsis">
      Skipping test instances when required (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-a-time-limit-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Setting a time limit (optional)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-of-mpi4py-test" class="md-nav__link">
    <span class="md-ellipsis">
      Background of the mpi4py test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background of the mpi4py test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-mpi4py-test" class="md-nav__link">
    <span class="md-ellipsis">
      The mpi4py test
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-portable-reframe-test-legacy" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: implementing as a portable ReFrame test without using EESSI_Mixin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: implementing as a portable ReFrame test without using EESSI_Mixin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-test-scales-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded test scales (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-module-names-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded module names (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replacing-hard-coded-valid_systems-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Replacing hard-coded valid_systems (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-sufficient-memory-mandatory" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting sufficient memory (mandatory)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requesting-taskprocessthread-binding-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Requesting task/process/thread binding (recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-omp_num_threads-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Defining OMP_NUM_THREADS (recommended)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="writing-portable-tests">Writing portable tests<a class="headerlink" href="#writing-portable-tests" title="Permanent link">&para;</a></h1>
<p>This page is a tutorial on how to write a new test for the <a href="https://github.com/EESSI/test-suite">EESSI test suite</a>.</p>
<p>If you already know how to write regular ReFrame tests, we suggest you read the <a href="#high-level-overview">High-level overview</a> and <a href="#test-requirements">Test requirements</a> sections, then skip ahead to <a href="#as-portable-reframe-test">Step 3: implementing as a portable ReFrame test</a>.</p>
<h2 id="high-level-overview">High-level overview<a class="headerlink" href="#high-level-overview" title="Permanent link">&para;</a></h2>
<p>In this tutorial, you will learn how to write a test for the <a href="https://www.eessi.io/docs/test-suite/">EESSI test suite</a>. It is important to realize in which context the test suite will be run. Roughly speaking, there are three uses:</p>
<ul>
<li>Running tests for one (or a few) particular applications, as part of the <a href="https://www.eessi.io/docs/adding_software/contribution_policy/#testing">workflow of adding new software to EESSI</a>,  to validate the sanity of the (new) installation</li>
<li>Regular (e.g. daily) runs, on a set of HPC clusters, to identify performance regressions</li>
<li>By an end-user of EESSI, who runs either a specific test or the full test suite, to validate the functionality of EESSI (or a particular software in EESSI) on the end-user's system</li>
</ul>
<p>The test suite contains a combination of real-life use cases for end-user scientific software (e.g. tests for GROMACS, TensorFlow, CP2K, OpenFOAM, etc) and low level tests (e.g. OSU Microbenchmarks).</p>
<p>The tests in the EESSI test suite are developed using the <a href="https://reframe-hpc.readthedocs.io/en/stable/">ReFrame HPC testing framework</a>. Typically, ReFrame tests hardcode system specific information (core counts, performance references, etc) in the test definition. The EESSI test suite aims to be portable, and implements a <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/eessi_mixin.py">mixin class</a> that invokes a series of standard <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">hooks</a> to replace information that is typically hardcoded. All system-specific information is then limited to the ReFrame configuration file. As an example: rather than hardcoding that a test should run with 128 tasks (i.e. because a system has 128 core nodes), the EESSI test suite has a hook that can define a test should be run on a "single, full node". The hook queries the ReFrame configuration file for the amount of cores per node, and specifies this number as the corresponding amount of tasks. Thus, on a 64-core node, this test would run with 64 tasks, while on a 128-core node, it would run 128 tasks.</p>
<h2 id="test-requirements">Test requirements<a class="headerlink" href="#test-requirements" title="Permanent link">&para;</a></h2>
<p>To be useful in the aforementioned scenarios, tests need to satisfy a number of requirements. </p>
<ul>
<li>Tests are implemented in the <a href="https://reframe-hpc.readthedocs.io/en/stable/">ReFrame HPC testing framework</a>.</li>
<li>Multiple tests may be implemented for a single software package.</li>
<li>Tests should run in a reasonable amount of time (less than 1 hour) for all the scales for which it is defined to be valid (on a recent CPU/GPU).</li>
<li>There should be at least one light-weight (short, low-core, low-memory) test case. On a decently sized machine (in 2024, that means about 8 cores and 16 GB memory), this test case should run in less than 5 minutes. This test should be marked with the 'CI' tag.</li>
<li>Tests should only use a reasonable amount of memory, so that <em>most</em> systems will be able to run them. For low core counts (1-8 cores), 8-16 GB is reasonable. For higher core counts, keeping a memory usage to less than 1 GB/core will ensure that <em>mosts</em> systems will be able to run it.</li>
<li>Tests should be portable, meaning they should not contain any system-specific information. If assumptions are made that might not be satisfied on every system (e.g. a test needs at least X cores to run), the test should check for it, and be skipped if the system does not satisfy the requirement.</li>
</ul>
<h2 id="step-by-step-tutorial-for-writing-a-portable-reframe-test">Step-by-step tutorial for writing a portable ReFrame test<a class="headerlink" href="#step-by-step-tutorial-for-writing-a-portable-reframe-test" title="Permanent link">&para;</a></h2>
<p>In the next section, we will show how to write a test for the EESSI test suite by means of an example: we will create a test for <a href="https://mpi4py.readthedocs.io/en/stable/">mpi4py</a> that executes an <code>MPI_REDUCE</code> call to sum the ranks of all processes. If you're unfamiliar with MPI or <code>mpi4py</code>, or want to see the exact code this test will run, you may want to read <a href="#background-of-mpi4py-test">Background of the mpi4py test</a> before proceeding. The complete test developed in this tutorial can be found in the <code>tutorials/mpi4py</code> directory in  of the <a href="https://github.com/EESSI/test-suite/">EESSI test suite</a> repository.</p>
<h3 id="step-1-writing-job-scripts-to-execute-tests">Step 1: writing job scripts to execute tests<a class="headerlink" href="#step-1-writing-job-scripts-to-execute-tests" title="Permanent link">&para;</a></h3>
<p>Although not strictly needed for the implementation of a ReFrame test, it is useful to try and write a job script for how you would want to run this test on a given system. For example, on a system with 128-core nodes, managed by SLURM, we might have the following job scripts to execute the <code>mpi4py_reduce.py</code> code.</p>
<p>To run on 2 cores:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1">#SBATCH --ntasks=2  # 2 tasks, since 2 processes is the minimal size on which I can do a reduction</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1">#SBATCH --cpus-per-task=1  # 1 core per task (this is a pure multiprocessing test, each process only uses 1 thread)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1">#SBATCH --time=5:00  # This test is very fast. It shouldn&#39;t need more than 5 minutes</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nb">source</span><span class="w"> </span>/cvmfs/software.eessi.io/versions/2023.06/init/bash
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>module<span class="w"> </span>load<span class="w"> </span>mpi4py/3.1.5-gompi-2023b
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">2</span><span class="w"> </span>python3<span class="w"> </span>mpi4py_reduce.py<span class="w"> </span>--n_iter<span class="w"> </span><span class="m">1000</span><span class="w"> </span>--n_warmup<span class="w"> </span><span class="m">100</span>
</code></pre></div>
To run on one full node:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">#SBATCH --ntasks=128  # min. 2 tasks in total, since 2 processes is the minimal size on which I can do a reduction</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1">#SBATCH --ntasks-per-node=128</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1">#SBATCH --cpus-per-task=1  # 1 core per task (this is a pure multiprocessing test, each process only uses 1 thread)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1">#SBATCH --time=5:00  # This test is very fast. It shouldn&#39;t need more than 5 minutes</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="nb">source</span><span class="w"> </span>/cvmfs/software.eessi.io/versions/2023.06/init/bash
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>module<span class="w"> </span>load<span class="w"> </span>mpi4py/3.1.5-gompi-2023b
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">128</span><span class="w"> </span>python3<span class="w"> </span>mpi4py_reduce.py<span class="w"> </span>--n_iter<span class="w"> </span><span class="m">1000</span><span class="w"> </span>--n_warmup<span class="w"> </span><span class="m">100</span>
</code></pre></div>
To run on two full nodes
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1">#SBATCH --ntasks=256 # min. 2 tasks in total, since 2 processes is the minimal size on which I can do a reduction</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">#SBATCH --ntasks-per-node=128 </span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">#SBATCH --cpus-per-task=1  # 1 core per task (this is a pure multiprocessing test, each process only uses 1 thread)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1">#SBATCH --time=5:00  # This test is very fast. It shouldn&#39;t need more than 5 minutes</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nb">source</span><span class="w"> </span>/cvmfs/software.eessi.io/versions/2023.06/init/bash
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>module<span class="w"> </span>load<span class="w"> </span>mpi4py/3.1.5-gompi-2023b
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">256</span><span class="w"> </span>python3<span class="w"> </span>mpi4py_reduce.py<span class="w"> </span>--n_iter<span class="w"> </span><span class="m">1000</span><span class="w"> </span>--n_warmup<span class="w"> </span><span class="m">100</span>
</code></pre></div></p>
<p>Clearly, such job scripts are not very portable: these only work on SLURM systems, we had to duplicate a lot to run on different scales, we would have to duplicate even more if we wanted to test multiple <code>mpi4py</code> versions, etc. This is where <code>ReFrame</code> comes in: it has support for different schedulers, and allows one to easily specify a range of parameters (such as the number of tasks in the above example) to create tests for.</p>
<h3 id="step-2-implementing-as-a-non-portable-reframe-test">Step 2: implementing as a non-portable ReFrame test<a class="headerlink" href="#step-2-implementing-as-a-non-portable-reframe-test" title="Permanent link">&para;</a></h3>
<p>First, let us implement this as a non-portable test in ReFrame. This code can be found under <code>tutorials/mpi4py/mpi4py_system_specific.py</code> in the <a href="https://github.com/EESSI/test-suite/">EESSI test suite</a> repository. We will not elaborate on how to write ReFrame tests, it is well-documented in the official <a href="https://reframe-hpc.readthedocs.io/en/stable/index.html">ReFrame documentation</a>. We have put extensive comments in the test definition below, to make it easier to understand when you have limited familiarity with ReFrame. Whenever the variables below have a specific meaning in ReFrame, we referenced the official documentation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="sd">This module tests mpi4py&#39;s MPI_Reduce call</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">reframe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rfm</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">reframe.utility.sanity</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sn</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># added only to make the linter happy</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">reframe.core.builtins</span><span class="w"> </span><span class="kn">import</span> <span class="n">variable</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">run_after</span><span class="p">,</span> <span class="n">performance_function</span><span class="p">,</span> <span class="n">sanity_function</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="c1"># This python decorator indicates to ReFrame that this class defines a test</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1"># Our class inherits from rfm.RunOnlyRegressionTest, since this test does not have a compilation stage</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RunOnlyRegressionTest</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">EESSI_MPI4PY</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">):</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="c1"># Programming environments are only relevant for tests that compile something</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="c1"># Since we are testing existing modules, we typically don&#39;t compile anything and simply define</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="c1"># &#39;default&#39; as the valid programming environment</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.valid_prog_environs</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="c1"># Typically, we list here the name of our cluster as it is specified in our ReFrame configuration file</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.valid_systems</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>    <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snellius&#39;</span><span class="p">]</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="c1"># ReFrame will generate a test for each module</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>    <span class="c1"># NOTE: each parameter adds a new dimension to the parametrization space. </span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="c1"># (EG 4 parameters with (3,3,2,2) possible values will result in 36 tests).</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    <span class="c1"># Be mindful of how many parameters you add to avoid the number of tests generated being excessive.</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.builtins.parameter</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;mpi4py/3.1.4-gompi-2023a&#39;</span><span class="p">,</span> <span class="s1">&#39;mpi4py/3.1.5-gompi-2023b&#39;</span><span class="p">])</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="c1"># ReFrame will generate a test for each scale</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="c1"># Our script has two arguments, --n_iter and --n_warmup. By defining these as ReFrame variables, we can</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="c1"># enable the end-user to overwrite their value on the command line when invoking ReFrame.</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="c1"># Note that we don&#39;t typically expose ALL variables, especially if a script has many - we expose</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>    <span class="c1"># only those that we think an end-user might want to overwrite</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>    <span class="c1"># Number of iterations to run (more iterations takes longer, but results in more accurate timing)</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.builtins.variable</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">variable</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>    <span class="c1"># Similar for the number of warmup iterations</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="n">n_warmup</span> <span class="o">=</span> <span class="n">variable</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>    <span class="c1"># Define which executable to run</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.executable</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>    <span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;python3&#39;</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>    <span class="c1"># Define which options to pass to the executable</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.executable_opts</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>    <span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mpi4py_reduce.py&#39;</span><span class="p">,</span> <span class="s1">&#39;--n_iter&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_iterations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;--n_warmup&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_warmup</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>    <span class="c1"># Define a time limit for the scheduler running this test</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.time_limit</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>    <span class="n">time_limit</span> <span class="o">=</span> <span class="s1">&#39;5m00s&#39;</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>    <span class="c1"># Using this decorator, we tell ReFrame to run this AFTER the init step of the test</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.builtins.run_after</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>    <span class="c1"># See https://reframe-hpc.readthedocs.io/en/stable/pipeline.html for all steps in the pipeline</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>    <span class="c1"># that reframe uses to execute tests. Note that after the init step, ReFrame has generated test instances for each</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>    <span class="c1"># of the combinations of parameters above. Thus, now, there are 6 instances (2 module names * 3 scales). Here,</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>    <span class="c1"># we set the modules to load equal to one of the module names</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.modules</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>    <span class="c1"># Similar for the scale, we now set the number of tasks equal to the scale for this instance</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_task_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>        <span class="c1"># Set the number of tasks, self.scale is now a single number out of the parameter list</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>        <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.num_tasks</span>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>        <span class="c1"># Set the number of tasks per node to either be equal to the number of tasks, but at most 128,</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>        <span class="c1"># since we have 128-core nodes</span>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>        <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.num_tasks_per_node</span>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>    <span class="c1"># Now, we check if the pattern &#39;Sum of all ranks: X&#39; with X the correct sum for the amount of ranks is found</span>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>    <span class="c1"># in the standard output:</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.builtins.sanity_function</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>    <span class="nd">@sanity_function</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>        <span class="c1"># Sum of 0, ..., N-1 is (N * (N-1) / 2)</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>        <span class="n">sum_of_ranks</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>        <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/deferrable_functions_reference.html#reframe.utility.sanity.assert_found</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Sum of all ranks: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sum_of_ranks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>    <span class="c1"># Now, we define a pattern to extract a number that reflects the performance of this test</span>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.builtins.performance_function</span>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>    <span class="nd">@performance_function</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>        <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/deferrable_functions_reference.html#reframe.utility.sanity.extractsingle</span>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Time elapsed:\s+(?P&lt;perf&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;perf&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
</code></pre></div>
<p>This single test class will generate 6 test instances: tests with 2, 128 and 256 tasks for each of the two modules, respectively. It will check the sum of ranks produced at the end in the output, which is how ReFrame will validate that the test ran correctly. Finally, it will also print the performance number that was extracted by the <code>performance_function</code>.</p>
<p>This test <em>works</em>, but is <em>not</em> very portable. If we move to a system with 192 cores per node, the current <code>scale</code> parameter is a bit awkward. The test would still run, but we wouldn't have a test instance that just tests this on a full (single) node or two full nodes. Furthermore, if we add a new <code>mpi4py</code> module in EESSI, we would have to alter the test to add the name to the list, since the module names are hardcoded in this test.</p>
<h3 id="as-portable-reframe-test">Step 3: implementing as a portable ReFrame test<a class="headerlink" href="#as-portable-reframe-test" title="Permanent link">&para;</a></h3>
<p>In step 2, there were several system-specific items in the test. In this section, we will show how we use inheritance from the <code>EESSI_Mixin</code> class to avoid hard-coding system specific information. The full final test can be found under <code>tutorials/mpi4py/mpi4py_portable_mixin.py</code> in the <a href="https://github.com/EESSI/test-suite/">EESSI test suite</a> repository.</p>
<h4 id="how-eessi_mixin-works">How EESSI_Mixin works<a class="headerlink" href="#how-eessi_mixin-works" title="Permanent link">&para;</a></h4>
<p>The <code>EESSI_Mixin</code> class provides standardized functionality that should be useful to all tests in the EESSI test-suite. One of its key functions is to make sure tests dynamically try to determine sensible values for the things that were system specific in Step 2. For example, instead of hard coding a task count, the test inheriting from <code>EESSI_Mixin</code> will determine this dynamically based on the amount of available cores per node, and a declaration from the inheriting test class about how you want to instantiate tasks.</p>
<p>To illustrate this, suppose you want to launch your test with one task per CPU core. In that case, your test (that inherits from <code>EESSI_Mixin</code>) only has to declare</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">compute_unit</span> <span class="o">=</span> <span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span>
</code></pre></div>
<p>The <code>EESSI_Mixin</code> class then takes care of querying the ReFrame config file for the cpu topology of the node, and setting the correct number of tasks per node.</p>
<p>Another feature is that it sets defaults for a few items, such as the <code>valid_prog_environs = ['default']</code>. These will likely be the same for <em>most</em> tests in the EESSI test suite, and when they <em>do</em> need to be different, one can easily overwrite them in the child class.</p>
<p>Most of the functionality in the <code>EESSI_Mixin</code> class require certain class attributes (such as the <code>compute_unit</code> above) to be set by the child class, so that the <code>EESSI_Mixin</code> class can use those as input. It is important that these attributes are set <em>before</em> the stage in which the <code>EESSI_Mixin</code> class needs them (see the stages of the <a href="https://reframe-hpc.readthedocs.io/en/stable/pipeline.html">ReFrame regression pipeline</a>). To support test developers, the <code>EESSI_Mixin</code> class checks if these attributes are set, and gives verbose feedback in case any attributes are missing.</p>
<h4 id="inheriting-from-eessi_mixin">Inheriting from EESSI_Mixin<a class="headerlink" href="#inheriting-from-eessi_mixin" title="Permanent link">&para;</a></h4>
<p>The first step is to actually inherit from the <code>EESSI_Mixin</code> class:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.eessi_mixin</span><span class="w"> </span><span class="kn">import</span> <span class="n">EESSI_Mixin</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="o">...</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">EESSI_MPI4PY</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">,</span> <span class="n">EESSI_Mixin</span><span class="p">):</span>
</code></pre></div>
<h4 id="removing-hard-coded-test-scales">Removing hard-coded test scales<a class="headerlink" href="#removing-hard-coded-test-scales" title="Permanent link">&para;</a></h4>
<p>First, we remove </p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>    <span class="c1"># ReFrame will generate a test for each scale</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
</code></pre></div>
from the test. The <code>EESSI_Mixin</code> class will define the default set of scales on which this test will be run as
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCALES</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="o">...</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">SCALES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></p>
<p>This ensures the test will run a test case for each of the default scales, as defined by the <code>SCALES</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/constants.py">constant</a>.</p>
<p>If, and only if, your test can not run on all of those scales should you overwrite this parameter in your child class. For example, if you have a test that does not support running on multiple nodes, you could define a filtering function outside of the class
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">filter_scales</span><span class="p">():</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>        <span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">SCALES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="p">]</span>
</code></pre></div>
and then in the class body overwrite the scale parameter with a subset of items from the <code>SCALES</code> constant:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">filter_scales</span><span class="p">())</span>
</code></pre></div></p>
<p>Next, we also remove</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>   <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_task_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
</code></pre></div>
<p>as <code>num_tasks</code> and and <code>num_tasks_per_node</code> will be set by the <code>assign_tasks_per_compute_unit</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">hook</a>, which is invoked by the <code>EESSI_Mixin</code> class.</p>
<p>Instead, we only set the <code>compute_unit</code>. The number of launched tasks will be equal to the number of compute units. E.g.
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>    <span class="n">compute_unit</span> <span class="o">=</span> <span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span>
</code></pre></div>
will launch one task per (physical) CPU core. Other options are <code>COMPUTE_UNITS.HWTHREAD</code> (one task per hardware thread), <code>COMPUTE_UNITS.NUMA_NODE</code> (one task per numa node), <code>COMPUTE_UNITS.CPU_SOCKET</code> (one task per CPU socket), <code>COMPUTE_UNITS.GPU</code> (one task per GPU) and <code>COMPUTE_UNITS.NODE</code> (one task per node). Check the <code>COMPUTE_UNITS</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/constants.py">constant</a> for the full list of valid compute units. The number of cores per task will automatically be set based on this as the ratio of the number of cores in a node to the number of tasks per node (rounded down). Additionally, the <code>EESSI_Mixin</code> class will set the <code>OMP_NUM_THREADS</code> environment variable equal to the number of cores per task.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>compute_unit</code> needs to be set before (or in) ReFrame's <code>setup</code> phase. For the different phases of the pipeline, please see the <a href="https://reframe-hpc.readthedocs.io/en/stable/pipeline.html">documentation on how ReFrame executes tests</a>.</p>
</div>
<h4 id="replacing-hard-coded-module-names">Replacing hard-coded module names<a class="headerlink" href="#replacing-hard-coded-module-names" title="Permanent link">&para;</a></h4>
<p>Instead of hard-coding a module name, we parameterize over all module names that match a certain regular expression. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_modules</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="o">...</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">find_modules</span><span class="p">(</span><span class="s1">&#39;mpi4py&#39;</span><span class="p">))</span>
</code></pre></div>
<p>This parameter generates all module names available on the current system matching the expression, and each test instance will load the respective module before running the test.</p>
<p>Furthermore, we remove the hook that sets <code>self.module</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span>
</code></pre></div>
This is now taken care of by the <code>EESSI_Mixin</code> class.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>module_name</code> needs to be set before (or in) ReFrame's <code>init</code> phase</p>
</div>
<h4 id="replacing-hard-coded-system-names-and-programming-environments">Replacing hard-coded system names and programming environments<a class="headerlink" href="#replacing-hard-coded-system-names-and-programming-environments" title="Permanent link">&para;</a></h4>
<p>First, we remove the hard-coded system name and programming environment. I.e. we remove
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>    <span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snellius&#39;</span><span class="p">]</span>
</code></pre></div>
The <code>EESSI_Mixin</code> class sets <code>valid_prog_environs = ['default']</code> by default, so that is no longer needed in the child class (but it can be overwritten if needed). The <code>valid_systems</code> is instead replaced by a declaration of what type of device type is needed. We'll create an <code>mpi4py</code> test that runs on CPUs only:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>    <span class="n">device_type</span> <span class="o">=</span> <span class="n">DEVICE_TYPES</span><span class="o">.</span><span class="n">CPU</span>
</code></pre></div>
but note if we would have wanted to also generate test instances to test GPU &lt;=&gt; GPU communication, we could have defined this as a parameter:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>    <span class="n">device_type</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="n">DEVICE_TYPES</span><span class="o">.</span><span class="n">CPU</span><span class="p">,</span> <span class="n">DEVICE_TYPES</span><span class="o">.</span><span class="n">GPU</span><span class="p">])</span>
</code></pre></div></p>
<p>The device type that is set will be used by the <code>filter_valid_systems_by_device_type</code> hook to check in the ReFrame configuration file which of the current partitions contain the relevant device. Typically, we don't set the <code>DEVICE_TYPES.CPU</code> on a GPU partition in the ReFrame configuration, so that we skip all CPU-only tests on GPU nodes. Check the <code>DEVICE_TYPES</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/constants.py">constant</a> for the full list of valid compute units.</p>
<p><code>EESSI_Mixin</code> also filters based on the supported scales, which can again be configured per partition in the ReFrame configuration file. This can e.g. be used to avoid running large-scale tests on partitions that don't have enough nodes to run them.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>device_type</code> needs to be set before (or in) ReFrame's <code>init</code> phase</p>
</div>
<h4 id="requesting-sufficient-ram-memory">Requesting sufficient RAM memory<a class="headerlink" href="#requesting-sufficient-ram-memory" title="Permanent link">&para;</a></h4>
<p>To make sure you get an allocation with sufficient memory, your test should declare how much memory per node it needs by defining a <code>required_mem_per_node</code> function in your test class that returns the required memory per node (in MiB). Note that the amount of required memory generally depends on the amount of tasks that are launched per node (<code>self.num_tasks_per_node</code>).</p>
<p>Our <code>mpi4py</code> test takes around 200 MB when running with a single task, plus about 70 MB for every additional task. We round this up a little so that we can be sure the test won't run out of memory if memory consumption is slightly different on a different system. Thus, we define:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">required_mem_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">250</span>
</code></pre></div>
<p>While rounding up is advisable, do keep your estimate realistic. Too high a memory request will mean the test will get skipped on systems that cannot satisfy that memory request. Most HPC systems have at least 1 GB per core, and most laptop/desktops have at least 8 GB total. Designing a test so that it fits within those memory constraints will ensure it can be run almost anywhere.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The easiest way to get the memory consumption of your test at various task counts is to execute it on a system which runs jobs in <a href="https://en.wikipedia.org/wiki/Cgroups">cgroups</a>, define <code>measure_memory_usage = True</code> in your class body, and make the <code>required_mem_per_node</code> function return a constant amount of memory equal to the available memory per node on your test system. This will cause the <code>EESSI_Mixin</code> class to read out the maximum memory usage of the cgroup (on the head node of your allocation, in case of multi-node tests) and report it as a performance number.</p>
</div>
<h4 id="process-binding">Process binding<a class="headerlink" href="#process-binding" title="Permanent link">&para;</a></h4>
<p>The <code>EESSI_Mixin</code> class binds processes to their respective number of cores automatically using the <code>hooks.set_compact_process_binding</code> hook. E.g. for a pure MPI test like <code>mpi4py</code>, each task will be bound to a single core. For hybrid tests that do both multiprocessing and multithreading, tasks are bound to a sequential number of cores. E.g. on a node with 128 cores and a hybrid test with 64 tasks and 2 threads per task, the first task will be bound to core 0 and 1, second task to core 2 and 3, etc. To override this behaviour, one would have to overwrite the
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_tasks_per_compute_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="o">...</span>
</code></pre></div>
function. Note that this function also calls other hooks (such as <code>hooks.assign_task_per_compute_unit</code>) that you probably still want to invoke. Check the <code>EESSI_Mixin</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/eessi_mixin.py">class definition</a> to see which hooks you still want to call.</p>
<h4 id="ci-tag">CI Tag<a class="headerlink" href="#ci-tag" title="Permanent link">&para;</a></h4>
<p>As mentioned in the <a href="#test-requirements">Test requirements</a>, there should be at least one light-weight (short, low-core, low-memory) test case, which should be marked with the <code>CI</code> tag. The <code>EESSI_Mixin</code> class will automatically add the <code>CI</code> tag if both <code>bench_name</code> (the current variant) and <code>bench_name_ci</code> (the CI variant) are defined. The <code>mpi4py</code> test contains only one test case (which is very light-weight). In this case, it is sufficient to set both to the same name in the class body:
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">bench_name</span> <span class="o">=</span> <span class="s1">&#39;mpi4pi&#39;</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">bench_name_ci</span> <span class="o">=</span> <span class="s1">&#39;mpi4pi&#39;</span>
</code></pre></div></p>
<p>Suppose that our test has 2 variants, of which only <code>'variant1'</code> should be marked <code>CI</code>. In that case, we can define <code>bench_name</code> as a parameter:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>    <span class="n">bench_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;variant1&#39;</span><span class="p">,</span> <span class="s1">&#39;variant2&#39;</span><span class="p">])</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="n">bench_name_ci</span> <span class="o">=</span> <span class="s1">&#39;variant1&#39;</span>
</code></pre></div>
Next, we can define a hook that does different things depending on the variant, for example: 
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bench_name</span> <span class="o">==</span> <span class="s1">&#39;variant1&#39;</span><span class="p">:</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>        <span class="n">do_this</span><span class="p">()</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bench_name</span> <span class="o">==</span> <span class="s1">&#39;variant2&#39;</span><span class="p">:</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>        <span class="n">do_that</span><span class="p">()</span>
</code></pre></div></p>
<h4 id="readonly-files">Readonly files<a class="headerlink" href="#readonly-files" title="Permanent link">&para;</a></h4>
<p>To avoid excessive copying of test input files into each stage directory, it is
highly recommended to specify a list of files and/or dirs in <code>sourcesdir</code> that
are needed but not modified during the test, and thus can be symlinked into the
stage dirs. In this case, file <code>mpi4py_reduce.py</code> does not change during the
test, so it can be safely symlinked:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>readonly_files = [&#39;mpi4py_reduce.py&#39;]
</code></pre></div>
We’ve made the <code>readonly_files</code> attribute mandatory for all tests to ensure it’s
not overlooked. If you are sure no files should be symlinked in your test, set
it to <code>['']</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>readonly_files = [&#39;&#39;]
</code></pre></div></p>
<h4 id="thread-binding-optional">Thread binding (optional)<a class="headerlink" href="#thread-binding-optional" title="Permanent link">&para;</a></h4>
<p>Thread binding is not done by default, but can be done by invoking the <code>hooks.set_compact_thread_binding</code> hook:
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">set_compact_thread_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></p>
<h4 id="skipping-test-instances">Skipping test instances when required (optional)<a class="headerlink" href="#skipping-test-instances" title="Permanent link">&para;</a></h4>
<p>Preferably, we prevent test instances from being generated (i.e. before ReFrame's <code>setup</code> phase) if we know that they cannot run on a certain system. However, sometimes we need information on the nodes that will run it, which is only available <em>after</em> the <code>setup</code> phase. That is the case for anything where we need information from e.g. the <a href="https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.current_partition">reframe.core.pipeline.RegressionTest.current_partition</a>.</p>
<p>For example, we might know that a test only scales to around 300 tasks, and above that, execution time increases rapidly. In that case, we'd want to skip any test instance that results in a larger amount of tasks, but we only know this after <code>assign_tasks_per_compute_unit</code> has been called (which is done by <code>EESSI_Mixin</code> in after the <code>setup</code> stage). For example, the <code>2_nodes</code> scale would run fine on systems with 128 cores per node, but would exceed the task limit of 300 on systems with <code>192</code> cores per node.</p>
<p>We can skip any generated test cases using the <code>skip_if</code> function. For example, to skip the test if the total task count exceeds 300, we'd need to call <code>skip_if</code> <em>after</em> the <code>setup</code> stage (so that <code>self.num_tasks</code> is already set):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">assign_tasks_per_compute_unit</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">compute_unit</span><span class="o">=</span><span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">max_tasks</span> <span class="o">=</span> <span class="mi">300</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">skip_if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">&gt;</span> <span class="n">max_tasks</span><span class="p">,</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>                 <span class="sa">f</span><span class="s1">&#39;Skipping test: more than </span><span class="si">{</span><span class="n">max_tasks</span><span class="si">}</span><span class="s1"> tasks are requested (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</code></pre></div>
<p>The <code>mpi4py</code> test scales up to a very high core count, but if we were to set it for the sake of this example, one would see:
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>16_nodes<span class="w"> </span>/38aea144<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="o">[</span><span class="w">     </span>SKIP<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">1</span>/13<span class="o">)</span><span class="w"> </span>Skipping<span class="w"> </span>test:<span class="w"> </span>more<span class="w"> </span>than<span class="w"> </span><span class="m">300</span><span class="w"> </span>tasks<span class="w"> </span>are<span class="w"> </span>requested<span class="w"> </span><span class="o">(</span><span class="m">3072</span><span class="o">)</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>8_nodes<span class="w"> </span>/bfc4d3d4<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="o">[</span><span class="w">     </span>SKIP<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">2</span>/13<span class="o">)</span><span class="w"> </span>Skipping<span class="w"> </span>test:<span class="w"> </span>more<span class="w"> </span>than<span class="w"> </span><span class="m">300</span><span class="w"> </span>tasks<span class="w"> </span>are<span class="w"> </span>requested<span class="w"> </span><span class="o">(</span><span class="m">1536</span><span class="o">)</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>4_nodes<span class="w"> </span>/8de369bc<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="o">[</span><span class="w">     </span>SKIP<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">3</span>/13<span class="o">)</span><span class="w"> </span>Skipping<span class="w"> </span>test:<span class="w"> </span>more<span class="w"> </span>than<span class="w"> </span><span class="m">300</span><span class="w"> </span>tasks<span class="w"> </span>are<span class="w"> </span>requested<span class="w"> </span><span class="o">(</span><span class="m">768</span><span class="o">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>2_nodes<span class="w"> </span>/364146ba<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="o">[</span><span class="w">     </span>SKIP<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">4</span>/13<span class="o">)</span><span class="w"> </span>Skipping<span class="w"> </span>test:<span class="w"> </span>more<span class="w"> </span>than<span class="w"> </span><span class="m">300</span><span class="w"> </span>tasks<span class="w"> </span>are<span class="w"> </span>requested<span class="w"> </span><span class="o">(</span><span class="m">384</span><span class="o">)</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_node<span class="w"> </span>/8225edb3<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_2_node<span class="w"> </span>/4acf483a<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_4_node<span class="w"> </span>/fc3d689b<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_8_node<span class="w"> </span>/73046a73<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1cpn_4nodes<span class="w"> </span>/f08712a2<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1cpn_2nodes<span class="w"> </span>/23cd550b<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>4_cores<span class="w"> </span>/bb8e1349<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>2_cores<span class="w"> </span>/4c0c7c9e<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="o">[</span><span class="w"> </span>RUN<span class="w">      </span><span class="o">]</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_core<span class="w"> </span>/aa83ba9e<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>...
</code></pre></div>
on a system with 192 cores per node. I.e. any test of 2 nodes (384 cores) or above would be skipped because it exceeds our max task count.</p>
<h4 id="setting-a-time-limit-optional">Setting a time limit (optional)<a class="headerlink" href="#setting-a-time-limit-optional" title="Permanent link">&para;</a></h4>
<p>By default, the <code>EESSI_Mixin</code> class sets a time limit for jobs of 1 hour. You can overwrite this in your child class:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">time_limit</span> <span class="o">=</span> <span class="s1">&#39;5m00s&#39;</span>
</code></pre></div>
For the appropriate string formatting, please check the <a href="https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.time_limit">ReFrame documentation on time_limit</a>. We already had this in the non-portable version of our <code>mpi4py</code> test and will keep it in the portable version: since this is a very quick test, specifying a lower time limit will help in getting the jobs scheduled more quickly.</p>
<p>Note that for the test to be portable, the time limit should be set such that it is sufficient <em>regardless of node architecture and scale</em>. It is pretty hard to guarantee this with a single, fixed time limit, without knowing upfront what architecture the test will be run on, and thus how many tasks will be launched. For strong scaling tests, you might want a higher time limit for low task counts, whereas for weak scaling tests you might want a higher time limit for higher task counts. To do so, you can consider setting the time limit after setup, and making it dependent on the task count.</p>
<p>Suppose we have a weak scaling test that takes 5 minutes with a single task, and 60 minutes with 10k tasks. We can set a time limit based on linear interpolation between those task counts:
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>    <span class="c1"># linearly interpolate between the single and 10k task count</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>    <span class="n">minutes</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">*</span> <span class="p">((</span><span class="mi">60</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s1">m00s&#39;</span>
</code></pre></div>
Note that this is typically an overestimate of how long the test will take for intermediate task counts, but that's ok: we'd rather overestimate than underestimate the runtime.</p>
<p>To be even safer, one could consider combining this with logic to <a href="#skipping-test-instances">skip tests</a> if the 10k task count is exceeded.</p>
<h4 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h4>
<p>To make the test portable, we added additional imports:
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.eessi_mixin</span><span class="w"> </span><span class="kn">import</span> <span class="n">EESSI_Mixin</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">COMPUTE_UNITS</span><span class="p">,</span> <span class="n">DEVICE_TYPES</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_modules</span>
</code></pre></div></p>
<p>Made sure the test inherits from <code>EESSI_Mixin</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EESSI_MPI4PY</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">runOnlyRegressionTest</span><span class="p">,</span> <span class="n">EESSI_Mixin</span><span class="p">):</span>
</code></pre></div></p>
<p>Removed the following from the class body:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">valid_prog_environs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snellius&#39;</span><span class="p">]</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;mpi4py/3.1.4-gompi-2023a&#39;</span><span class="p">,</span> <span class="s1">&#39;mpi4py/3.1.5-gompi-2023b&#39;</span><span class="p">])</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
</code></pre></div></p>
<p>Added the following to the class body:
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">device_type</span> <span class="o">=</span> <span class="n">DEVICE_TYPES</span><span class="o">.</span><span class="n">CPU</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">compute_unit</span> <span class="o">=</span> <span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">find_modules</span><span class="p">(</span><span class="s1">&#39;mpi4py&#39;</span><span class="p">))</span>
</code></pre></div></p>
<p>Defined the class method:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">required_mem_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">250</span>
</code></pre></div></p>
<p>Removed the ReFrame pipeline hook that sets <code>self.modules</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>     <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span>
</code></pre></div></p>
<p>Removed the ReFrame pipeline hook that sets the number of tasks and number of tasks per node:
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">define_task_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>    <span class="c1"># Set the number of tasks, self.scale is now a single number out of the parameter list</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.num_tasks</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>    <span class="c1"># Set the number of tasks per node to either be equal to the number of tasks, but at most 128,</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>    <span class="c1"># since we have 128-core nodes</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>    <span class="c1"># https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.num_tasks_per_node</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
</code></pre></div></p>
<p>The final test is thus:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="sd">This module tests mpi4py&#39;s MPI_Reduce call</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">reframe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rfm</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">reframe.utility.sanity</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sn</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">reframe.core.builtins</span><span class="w"> </span><span class="kn">import</span> <span class="n">variable</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">run_after</span><span class="p">,</span> <span class="n">performance_function</span><span class="p">,</span> <span class="n">sanity_function</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.eessi_mixin</span><span class="w"> </span><span class="kn">import</span> <span class="n">EESSI_Mixin</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">COMPUTE_UNITS</span><span class="p">,</span> <span class="n">DEVICE_TYPES</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_modules</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="nd">@rfm</span><span class="o">.</span><span class="n">simple_test</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">EESSI_MPI4PY</span><span class="p">(</span><span class="n">rfm</span><span class="o">.</span><span class="n">RunOnlyRegressionTest</span><span class="p">,</span> <span class="n">EESSI_Mixin</span><span class="p">):</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>    <span class="n">device_type</span> <span class="o">=</span> <span class="n">DEVICE_TYPES</span><span class="o">.</span><span class="n">CPU</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="n">compute_unit</span> <span class="o">=</span> <span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">find_modules</span><span class="p">(</span><span class="s1">&#39;mpi4py&#39;</span><span class="p">))</span>
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>    <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">variable</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>    <span class="n">n_warmup</span> <span class="o">=</span> <span class="n">variable</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>
<a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>    <span class="n">executable</span> <span class="o">=</span> <span class="s1">&#39;python3&#39;</span>
<a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>    <span class="n">executable_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mpi4py_reduce.py&#39;</span><span class="p">,</span> <span class="s1">&#39;--n_iter&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_iterations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;--n_warmup&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_warmup</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
<a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a>
<a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a>    <span class="n">time_limit</span> <span class="o">=</span> <span class="s1">&#39;5m00s&#39;</span>
<a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a>
<a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>    <span class="n">bench_name</span> <span class="o">=</span> <span class="s1">&#39;mpi4pi&#39;</span>
<a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a>    <span class="n">bench_name_ci</span> <span class="o">=</span> <span class="s1">&#39;mpi4pi&#39;</span>
<a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a>
<a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a>    <span class="n">readonly_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mpi4py_reduce.py&#39;</span><span class="p">]</span>
<a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a>
<a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">required_mem_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">250</span>
<a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a>
<a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a>    <span class="nd">@sanity_function</span>
<a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a>        <span class="n">sum_of_ranks</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">assert_found</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Sum of all ranks: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sum_of_ranks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a>
<a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a>    <span class="nd">@performance_function</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<a id="__codelineno-36-43" name="__codelineno-36-43" href="#__codelineno-36-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-36-44" name="__codelineno-36-44" href="#__codelineno-36-44"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^Time elapsed:\s+(?P&lt;perf&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;perf&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
</code></pre></div></p>
<p>Note that with only 44 lines of code, this is now very quick and easy to write, because of the default behaviour from the <code>EESSI_Mixin</code> class.</p>
<h3 id="background-of-mpi4py-test">Background of the mpi4py test<a class="headerlink" href="#background-of-mpi4py-test" title="Permanent link">&para;</a></h3>
<p>To understand what this test does, you need to know some basics of MPI. If you know about MPI, you can skip this section.</p>
<p>The MPI standard defines how to communicate between multiple processes that work on a common computational task. Each process that is part of the computational task gets a unique identifier (0 to N-1 for N processes), the MPI rank, which can e.g. be used to distribute a workload. The MPI standard defines communication between two given processes (so-called point-to-point communication), but also between a set of N processes (so-called collective communication).</p>
<p>An example of such a collective operation is the <a href="https://www.mpi-forum.org/docs/mpi-4.1/mpi41-report/node130.htm#Node130">MPI_REDUCE</a> call. It reduces data elements from multiple processes with a certain operation, e.g. it takes the sum of all elements or multiplication of all elements.</p>
<h4 id="the-mpi4py-test">The mpi4py test<a class="headerlink" href="#the-mpi4py-test" title="Permanent link">&para;</a></h4>
<p>In this example, we will implement a test that does an <code>MPI_Reduce</code> on the rank, using the <code>MPI.SUM</code> operation. This makes it easy to validate the result, as we know that for N processes, the theoretical sum of all ranks (0, 1, ... N-1) is <code>(N * (N-1) / 2)</code>.</p>
<p>Our initial code is a python script <code>mpi4py_reduce.py</code>, which can be found in <code>tutorials/mpi4py/src/mpi4py_reduce.py</code> in the <a href="https://github.com/EESSI/test-suite/">EESSI test suite</a> repository:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="ch">#!/usr/bin/env python</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="sd">MPI_Reduce on MPI rank. This should result in a total of (size * (size - 1) / 2),</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="sd">where size is the total number of ranks.</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="sd">Prints the total number of ranks, the sum of all ranks, and the time elapsed for the reduction.&quot;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;mpi4py reduction benchmark&#39;</span><span class="p">,</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>                                 <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_warmup&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of warmup iterations&#39;</span><span class="p">)</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_iter&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of benchmark iterations&#39;</span><span class="p">)</span>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="n">n_warmup</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_warmup</span>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="n">n_iter</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">n_iter</span>
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>
<a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a><span class="n">size</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
<a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a><span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
<a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="n">name</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Get_processor_name</span><span class="p">()</span>
<a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>
<a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a><span class="c1"># Warmup</span>
<a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_warmup</span><span class="p">):</span>
<a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
<a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a>
<a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a><span class="c1"># Actual reduction, multiple iterations for accuracy of timing</span>
<a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a><span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
<a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">)</span>
<a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a><span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a><span class="n">total_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_iter</span>
<a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>
<a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a><span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total ranks: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of all ranks: </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Should be (size * (size-1) / 2)</span>
<a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time elapsed: </span><span class="si">{</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>Assuming we have <code>mpi4py</code> available, we could run this manually using
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>$<span class="w"> </span>mpirun<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span>python3<span class="w"> </span>mpi4py_reduce.py
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>Total<span class="w"> </span>ranks:<span class="w"> </span><span class="m">4</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>Sum<span class="w"> </span>of<span class="w"> </span>all<span class="w"> </span>ranks:<span class="w"> </span><span class="m">6</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>Time<span class="w"> </span>elapsed:<span class="w"> </span><span class="m">3</span>.609e-06
</code></pre></div></p>
<p>This started 4 processes, with ranks 0, 1, 2, 3, and then summed all the ranks (<code>0+1+2+3=6</code>) on the process with rank 0, which finally printed all this output. The whole reduction operation is performed <code>n_iter</code> times, so that we get a more reproducible timing.</p>
<h3 id="as-portable-reframe-test-legacy">Step 3: implementing as a portable ReFrame test without using EESSI_Mixin<a class="headerlink" href="#as-portable-reframe-test-legacy" title="Permanent link">&para;</a></h3>
<p>The approach using inheritance from the <code>EESSI_Mixin</code> class, described above, is strongly preferred and recommended. There might be certain tests that do not fit the standardized approach of <code>EESSI_Mixin</code>, but usually that will be solvable by overwriting hooks set by <code>EESSI_Mixin</code> in the inheriting class. In the rare case that your test is so exotic that even this doesn't provide a sensible solution, you can still invoke the hooks used by <code>EESSI_Mixin</code> manually. Note that this used to be the default way of writing tests for the EESSI test suite.</p>
<p>In step 2, there were several system-specific items in the test. In this section, we will show how we use the EESSI hooks to avoid hard-coding system specific information. We do this by replacing the system-specific parts of the test from Step 2 bit by bit. The full final test can be found under <code>tutorials/mpi4py/mpi4py_portable_legacy.py</code> in the <a href="https://github.com/EESSI/test-suite/">EESSI test suite</a> repository.</p>
<h4 id="replacing-hard-coded-test-scales-mandatory">Replacing hard-coded test scales (mandatory)<a class="headerlink" href="#replacing-hard-coded-test-scales-mandatory" title="Permanent link">&para;</a></h4>
<p>We replace the hard-coded</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>    <span class="c1"># ReFrame will generate a test for each scale</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
</code></pre></div>
<p>by </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCALES</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="o">...</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>    <span class="c1"># ReFrame will generate a test for each scale</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>    <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">SCALES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div>
<p>the <code>SCALES</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/constants.py">constant</a> contains a set of default scales at which we run all tests. For our <code>mpi4py</code> example, that is sufficient. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It might be that particular tests do not make sense at certain scales. An example is code that only has multithreading, but no multiprocessing support, and is thus only able to run on a single node. In that case, we filter the set of <code>SCALES</code> down to only those where <code>num_nodes = 1</code>, and parameterize the test across those scales:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCALES</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_singlenode_scales</span><span class="p">():</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="sd">    Filtering function for single node tests</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>        <span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">SCALES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>    <span class="p">]</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>   <span class="o">...</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>   <span class="n">scale</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">get_singlenode_scales</span><span class="p">())</span>
</code></pre></div>
</div>
<p>We also replace</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">define_task_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
</code></pre></div>
<p>by</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite</span><span class="w"> </span><span class="kn">import</span> <span class="n">hooks</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCALES</span><span class="p">,</span> <span class="n">COMPUTE_UNITS</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>    <span class="o">...</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_after_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>        <span class="n">hooks</span><span class="o">.</span><span class="n">set_tag_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_num_tasks_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Setting number of tasks per node and cpus per task in this function. This function sets num_cpus_per_task</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="sd">        for 1 node and 2 node options where the request is for full nodes.&quot;&quot;&quot;</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>        <span class="n">hooks</span><span class="o">.</span><span class="n">assign_tasks_per_compute_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">COMPUTE_UNITS</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
</code></pre></div>
<p>The first <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">hook</a> (<code>set_tag_scale</code>) sets a number of custom attributes for the current test, based on the scale (<code>self.num_nodes</code>, <code>self.default_num_cpus_per_node</code>, <code>self.default_num_gpus_per_node</code>, <code>self.node_part</code>). These are not used by ReFrame, but can be used by later hooks from the EESSI test suite. It also sets a ReFrame scale <code>tag</code> for convenience. These scale <code>tag</code>s are useful for quick test selection, e.g. by running ReFrame with <code>--tag 1_node</code> one would only run the tests generated for the scale <code>1_node</code>. Calling this hook is mandatory for all tests, as it ensures standardization of tag names based on the scales.</p>
<p>The second hook, <code>assign_tasks_per_compute_unit</code>, is used to set the task count. This hook sets the <code>self.num_tasks</code> and <code>self.num_tasks_per_node</code> we hardcoded before. In addition, it sets the <code>self.num_cpus_per_task</code>. In this case, we call it with the <code>COMPUTE_UNITS.CPU</code> argument, which means one task will be launched per (physical) CPU available. Thus, for the <code>1_node</code> scale, this would run the <code>mpi4py</code> test with 128 tasks on a 128-core node, and with 192 tasks on a 192-core node. Check the <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">code</a> for other valid <code>COMPUTE_UNITS</code>.</p>
<h4 id="replacing-hard-coded-module-names-mandatory">Replacing hard-coded module names (mandatory)<a class="headerlink" href="#replacing-hard-coded-module-names-mandatory" title="Permanent link">&para;</a></h4>
<p>If we write an <code>mpi4py</code> test, we typically want to run this for <em>all</em> <code>mpi4py</code> modules that are available via our current <code>$MODULEPATH</code>. We do that by replacing</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">([</span><span class="s1">&#39;mpi4py/3.1.4-gompi-2023a&#39;</span><span class="p">,</span> <span class="s1">&#39;mpi4py/3.1.5-gompi-2023b&#39;</span><span class="p">])</span>
</code></pre></div>
<p>by using the <code>find_modules</code> utility function:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_modules</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="o">...</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    <span class="n">module_name</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">(</span><span class="n">find_modules</span><span class="p">(</span><span class="s1">&#39;mpi4py&#39;</span><span class="p">))</span>
</code></pre></div>
<p>We also replace</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">]</span>
</code></pre></div>
<p>by</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>    <span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>        <span class="n">hooks</span><span class="o">.</span><span class="n">set_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>The <code>set_modules</code> hook assumes that <code>self.module_name</code> has been set, but has the added advantage that a user running the EESSI test suite can overwrite the modules to load from the command line when running ReFrame (see <a href="https://www.eessi.io/docs/test-suite/usage/#overriding-test-parameters-advanced">Overriding test parameters</a>).</p>
<h4 id="replacing-hard-coded-valid_systems-mandatory">Replacing hard-coded valid_systems (mandatory)<a class="headerlink" href="#replacing-hard-coded-valid_systems-mandatory" title="Permanent link">&para;</a></h4>
<p>The <code>valid_systems</code> attribute is a mandatory attribute to specify in a ReFrame test. However, we can set it to match any system:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">valid_systems</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="p">]</span>
</code></pre></div>
<p>Normally, <code>valid_systems</code> is used as a way of guaranteeing that a system has the necessary properties to run the test. For example, if we know that <code>my_gpu_system</code> has NVIDIA GPUs and I have a test written for NVIDIA GPUs, I would specify <code>valid_systems['my_gpu_system']</code> for that test. This, however, is a surrogate for declaring what my test <em>needs</em>: I'm saying it needs <code>my_gpu_system</code>, while in fact I could make the more general statement 'this test needs NVIDIA GPUs'.</p>
<p>To keep the test system-agnostic we <em>can</em> declare what the test needs by using ReFrame's concept of partition <code>features</code> (a string) and/or <code>extras</code> (a key-value pair); <a href="https://reframe-hpc.readthedocs.io/en/stable/regression_test_api.html#reframe.core.pipeline.RegressionTest.valid_systems">see the ReFrame documentation on <code>valid_systems</code></a>. For example, a test could declare it <em>needs</em> the <code>gpu</code> feature. Such a test will only be created by ReFrame for partitions that declare (in the ReFrame configuration file) that they have the <code>gpu</code> feature.</p>
<p>Since <code>features</code> and <code>extras</code> are full text fields, we standardize those in the EESSI test suite in the <code>eessi/testsuite/constants.py</code> file. For example, tests that require an NVIDIA GPU could specify</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXTRAS</span><span class="p">,</span> <span class="n">FEATURES</span><span class="p">,</span> <span class="n">GPU_VENDORS</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="o">...</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">valid_systems</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;+</span><span class="si">{</span><span class="n">FEATURES</span><span class="o">.</span><span class="n">GPU</span><span class="si">}</span><span class="s1"> %</span><span class="si">{</span><span class="n">EXTRAS</span><span class="o">.</span><span class="n">GPU_VENDOR</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">GPU_VENDORS</span><span class="o">.</span><span class="n">NVIDIA</span><span class="si">}</span><span class="s1">&#39;</span>
</code></pre></div>
<p>which makes sure that a test instance is only generated for partitions (as defined in the ReFrame configuration file) that specify that they <em>have</em> the corresponding feature and extras:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">eessi.testsuite.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXTRAS</span><span class="p">,</span> <span class="n">FEATURES</span><span class="p">,</span> <span class="n">GPU_VENDORS</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="o">...</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>     <span class="n">FEATURES</span><span class="o">.</span><span class="n">GPU</span><span class="p">,</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="p">],</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="s1">&#39;extras&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="n">EXTRAS</span><span class="o">.</span><span class="n">GPU_VENDOR</span><span class="p">:</span> <span class="n">GPU_VENDORS</span><span class="o">.</span><span class="n">NVIDIA</span><span class="p">,</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="p">},</span>
</code></pre></div>
<p>In practice, one will rarely hard-code this <code>valid_systems</code> string. Instead, we have a <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">hook</a> <code>filter_valid_systems_by_device_type</code>. It does the above, and a bit more: it also checks if the module that the test is generated for is CUDA-enabled (in case of a test for <code>NVIDIA</code> GPUs), and <em>only then</em> will it generate a GPU-based test. Calling this hook is mandatory for all tests (even if just to declare they need a CPU to run).</p>
<p>Another aspect is that not all ReFrame partitions may be able to run tests of all of the standard <code>SCALES</code>. Each ReFrame partition must add the subset of <code>SCALES</code> it supports to its list of features.  A test case can declare it needs a certain scale. For example, a test case using the <code>16_nodes</code> scale needs a partition with at least 16 nodes. The <code>filter_supported_scales</code> <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">hook</a> then filters out all partitions that do not support running jobs on 16 nodes. Calling this hook is also mandatory for all tests.</p>
<p>There may be other hooks that facilitate valid system selection for your tests, but please check the <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">code</a> for a full list.</p>
<h4 id="requesting-sufficient-memory-mandatory">Requesting sufficient memory (mandatory)<a class="headerlink" href="#requesting-sufficient-memory-mandatory" title="Permanent link">&para;</a></h4>
<p>When developing the test, we don't know how much memory the node will have on which it will run. However, we <em>do</em> know how much our application <em>needs</em>.</p>
<p>We can declare this need using the <code>req_memory_per_node</code> hook. This hook is mandatory for all tests. If you are on a system with a scheduler that runs jobs within a cgroup and where you can use <code>mpirun</code> or <code>srun</code> as the parallel launcher command in the ReFrame configuration, getting the memory consumption is easy. You can (temporarily) add a <code>postrun_cmds</code> the following to the class body of your test that extracts the maximum memory that was used within your cgroup. For cgroups v1, the syntax would be:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>   <span class="c1"># Temporarily define postrun_cmds to make it easy to find out memory usage</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>    <span class="n">postrun_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MAX_MEM_IN_BYTES=$(&lt;/sys/fs/cgroup/memory/$(&lt;/proc/self/cpuset)/../memory.max_usage_in_bytes)&#39;</span><span class="p">,</span> <span class="s1">&#39;echo &quot;MAX_MEM_IN_MIB=$(($MAX_MEM_IN_BYTES/1048576))&quot;&#39;</span><span class="p">]</span>
</code></pre></div>
<p>For cgroups v2, the syntax would be:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>   <span class="c1"># Temporarily define postrun_cmds to make it easy to find out memory usage</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>   <span class="n">postrun_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MAX_MEM_IN_BYTES=$(&lt;/sys/fs/cgroup/$(&lt;/proc/self/cpuset)/../../../memory.peak)&#39;</span><span class="p">,</span> <span class="s1">&#39;echo &quot;MAX_MEM_IN_MIB=$(($MAX_MEM_IN_BYTES/1048576))&quot;&#39;</span><span class="p">]</span>
</code></pre></div>
<p>And define an additional <code>performance_function</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>    <span class="nd">@performance_function</span><span class="p">(</span><span class="s1">&#39;MiB&#39;</span><span class="p">)</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">max_mem_in_mib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>        <span class="k">return</span> <span class="n">sn</span><span class="o">.</span><span class="n">extractsingle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^MAX_MEM_IN_MIB=(?P&lt;perf&gt;\S+)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s1">&#39;perf&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</code></pre></div>
<p>This results in the following output on 192-core nodes (we've omitted some output for readability):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="o">[</span>----------<span class="o">]</span><span class="w"> </span>start<span class="w"> </span>processing<span class="w"> </span>checks
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">1</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>16_nodes<span class="w"> </span>/38aea144<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">22018</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">2</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>8_nodes<span class="w"> </span>/bfc4d3d4<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">21845</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">3</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>4_nodes<span class="w"> </span>/8de369bc<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">21873</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">4</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>2_nodes<span class="w"> </span>/364146ba<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">21800</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">5</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_node<span class="w"> </span>/8225edb3<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">21666</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">6</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_2_node<span class="w"> </span>/4acf483a<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">10768</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">7</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_4_node<span class="w"> </span>/fc3d689b<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">5363</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">8</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_8_node<span class="w"> </span>/73046a73<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">2674</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">9</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1cpn_4nodes<span class="w"> </span>/f08712a2<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">210</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">10</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1cpn_2nodes<span class="w"> </span>/23cd550b<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">209</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">11</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>4_cores<span class="w"> </span>/bb8e1349<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">753</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">12</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>2_cores<span class="w"> </span>/4c0c7c9e<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">403</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
<a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a><span class="o">[</span><span class="w">       </span>OK<span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="m">13</span>/13<span class="o">)</span><span class="w"> </span>EESSI_MPI4PY<span class="w"> </span>%module_name<span class="o">=</span>mpi4py/3.1.5-gompi-2023b<span class="w"> </span>%scale<span class="o">=</span>1_core<span class="w"> </span>/aa83ba9e<span class="w"> </span>@snellius:genoa+default
<a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>P:<span class="w"> </span>max_mem_in_mib:<span class="w"> </span><span class="m">195</span><span class="w"> </span>MiB<span class="w"> </span><span class="o">(</span>r:0,<span class="w"> </span>l:None,<span class="w"> </span>u:None<span class="o">)</span>
</code></pre></div>
<p>If you are <em>not</em> on a system where your scheduler runs jobs in cgroups, you will have to figure out the memory consumption in another way (e.g. by checking memory usage in <code>top</code> while running the test).</p>
<p>We now have a pretty good idea how the memory per node scales: for our smallest process count (1 core), it's about 200 MiB per process, while for our largest process count (16 nodes, 16*192 processes), it's 22018 MiB per node (or about 115 MiB per process). If we wanted to do really well, we could define a linear function (with offset) and fit it through the data (and round up to be on the safe side, i.e. make sure there is <em>enough</em> memory). Then, we could call the hook like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">request_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>    <span class="n">mem_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">*</span> <span class="n">mem_slope</span> <span class="o">+</span> <span class="n">mem_intercept</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">req_memory_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_mem_req</span><span class="o">=</span><span class="n">mem_required</span><span class="p">)</span>
</code></pre></div>
<p>In this case, however, the memory consumption per process is low enough that we don't have go through that effort, and generously request 256 MiB per task that is launched on a node. Thus, we call our hook using:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">request_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>    <span class="n">mem_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks_per_node</span> <span class="o">*</span> <span class="mi">256</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">req_memory_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_mem_req</span><span class="o">=</span><span class="n">mem_required</span><span class="p">)</span>
</code></pre></div>
Note that requesting too high an amount of memory means the test will be skipped on nodes that cannot meet that requirement (even if they might have been able to run it without <em>actually</em> running out of memory). Requesting too little will risk nodes running out of memory while running the test. Note that many HPC systems have an amount memory of around 1-2 GB/core. It's good to ensure (if you can) that the memory requests for all valid <code>SCALES</code> for your test do not exceed the total amount of memory available on typical nodes.</p>
<h4 id="requesting-taskprocessthread-binding-recommended">Requesting task/process/thread binding (recommended)<a class="headerlink" href="#requesting-taskprocessthread-binding-recommended" title="Permanent link">&para;</a></h4>
<p>Binding processes to a set of cores prevents the OS from migrating such processes to other cores. Especially on multi-socket systems, process migration can cause performance hits, especially if a process is moved to a CPU core on the other socket. Since this is controlled by the OS, and dependent on what other processes are running on the node, it may cause unpredictable performance: in some runs, processes might be migrated, while in others, they aren't.</p>
<p>Thus, it is typically better for reproducibility to bind processes to their respective set of cores. The <code>set_compact_process_binding</code> hook can do this for you:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">set_compact_process_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>For pure MPI codes, it will bind rank 0 to core 0, rank 1 to core 1, etc. For hybrid codes (MPI + OpenMP, or otherwise codes that do both multiprocessing and multithreading at the same time), it will bind to consecuitive sets of cores. E.g. if a single process uses 4 cores, it will bind rank 0 to cores 0-3, rank 1 to cores 4-7, etc. </p>
<p>To impose this binding, the hook sets environment variables that should be respected by the parallel launcher used to launch your application. Check the <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">code</a> to see which parallel launchers are currently supported. The use of this hook is optional, but generally recommended for all multiprocessing codes.</p>
<p>For multithreading codes, there <code>set_compact_thread_binding</code> hook is an equivalent hook that can do thread binding, if supported multithreading frameworks are used (e.g. Intel or GNU OpenMP, see the <a href="https://github.com/EESSI/test-suite/blob/main/eessi/testsuite/hooks.py">code</a> for all supported frameworks):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nd">@run_after</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="n">hooks</span><span class="o">.</span><span class="n">set_compact_thread_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>The use of this hook is optional but recommended in most cases. Note that thread binding can sometimes cause unwanted behaviour: even if e.g. 8 cores are allocated to the process and 8 threads are launched, we have seen codes that bind all those threads to a single core (e.g. core 0) when core binding is enabled. Please verify that enabling core binding does not introduce any unwanted binding behaviour for your code.</p>
<h4 id="defining-omp_num_threads-recommended">Defining OMP_NUM_THREADS (recommended)<a class="headerlink" href="#defining-omp_num_threads-recommended" title="Permanent link">&para;</a></h4>
<p>The <code>set_omp_num_threads</code> hook sets the <code>$OMP_NUM_THREADS</code> environment variable based on the number of <code>cpus_per_task</code> defined in the ReFrame test (which in turn is typically set by the <code>assign_tasks_per_compute_unit</code> hook). For OpenMP codes, it is generally recommended to call this hook, to ensure they launch the correct amount of threads.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="March 14, 2025 09:14:25">March 14, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/eessi_hpc" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["instant", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs" type="module"></script>
      
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
      
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
      
        <script src="../../available_software/javascripts/populate_overview.js"></script>
      
        <script src="https://cdn.datatables.net/plug-ins/2.2.2/pagination/bootstrap_input.js"></script>
      
    
  </body>
</html>